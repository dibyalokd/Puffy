

import requests
import zipfile
import io

def download_and_extract_xml(base_url, repo_path, auth_token):
    """
    Downloads zip and extracts output.xml.
    repo_path should look like: 'my-repo/folder/subfolder/file.zip'
    """
    # 1. Sanitize the URL
    # Ensure base_url doesn't end with / and repo_path doesn't start with /
    base_url = base_url.rstrip('/')
    repo_path = repo_path.lstrip('/')
    
    download_url = f"{base_url}/{repo_path}"
    
    # 2. Setup Headers
    headers = {
        "Authorization": f"Bearer {auth_token}",
        "User-Agent": "Mozilla/5.0"  # Some proxies block scripts but allow browser-like agents
    }

    print(f"--- Debugging ---")
    print(f"Target URL: {download_url}")
    
    try:
        response = requests.get(download_url, headers=headers, stream=True)
        
        # If you get a 404 here, the 'download_url' printed above is 
        # exactly what you should compare against your browser URL.
        if response.status_code != 200:
            print(f"Error {response.status_code}: Resource not found.")
            print(f"Artifactory Message: {response.text}")
            return None

        # 3. Extract in-memory
        with zipfile.ZipFile(io.BytesIO(response.content)) as z:
            # Look for output.xml (case-insensitive search)
            xml_filename = next((f for f in z.namelist() if f.lower().endswith("output.xml")), None)
            
            if not xml_filename:
                print("Inside the zip, but couldn't find output.xml")
                return None
            
            with z.open(xml_filename) as f:
                return f.read().decode('utf-8')

    except Exception as e:
        print(f"An error occurred: {e}")
        return None

# --- CONFIG ---
# If your browser URL is: https://corp.artifactory.com/artifactory/my-repo/file.zip
# Then BASE_URL = "https://corp.artifactory.com/artifactory"
# And FILE_PATH = "my-repo/file.zip"

BASE = "https://your-instance.com/artifactory"
PATH = "repo-name/path/to/your/file.zip" 
TOKEN = "your_token_here"

xml_data = download_and_extract_xml(BASE, PATH, TOKEN)

if xml_data:
    print("Successfully extracted output.xml")
    print(xml_data[:500])



1111111

import requests
import zipfile
import io

def get_xml_from_artifactory_path(base_url, full_path, auth_token):
    """
    Downloads a zip from a known path and extracts the output.xml content.
    """
    # Ensure the URL is constructed correctly
    # full_path should be 'repo-key/path/to/file.zip'
    download_url = f"{base_url}/{full_path}"
    
    headers = {"Authorization": f"Bearer {auth_token}"}
    
    print(f"Fetching: {download_url}")
    response = requests.get(download_url, headers=headers)
    
    if response.status_code != 200:
        print(f"Failed to download. Status: {response.status_code}")
        print(f"Reason: {response.text}")
        return None

    # Open the zip in memory
    with zipfile.ZipFile(io.BytesIO(response.content)) as z:
        # Search for output.xml anywhere in the zip structure
        xml_filename = next((f for f in z.namelist() if f.endswith("output.xml")), None)
        
        if not xml_filename:
            print("Error: output.xml not found inside the zip file.")
            return None
        
        print(f"Extracting: {xml_filename}")
        with z.open(xml_filename) as xml_file:
            return xml_file.read().decode("utf-8")

# --- Configuration ---
BASE_URL = "https://your-artifactory-instance.com/artifactory"
# Example: "libs-release-local/com/app/1.0/app-1.0.zip"
FILE_PATH = "your-repo/folder/subfolder/filename.zip"
TOKEN = "your_access_token"

xml_content = get_xml_from_artifactory_path(BASE_URL, FILE_PATH, TOKEN)

if xml_content:
    print("Successfully read output.xml!")
    # print(xml_content) # Uncomment to see the full XML
